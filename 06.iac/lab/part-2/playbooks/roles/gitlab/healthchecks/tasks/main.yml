---
# OPTIONAL TASKS (needed to run checks from the host machine)
# - name: Uncomment the GitLab IP whitelist line
#   replace:
#     path: /etc/gitlab/gitlab.rb
#     regexp: '^# (gitlab_rails\[''monitoring_whitelist''\] = \[.*)\]$'
#     replace: '\1, ''20.20.20.1'']'

# - name: Reconfigure GitLab
#   command: gitlab-ctl reconfigure

# - name: Restart unicorn
#   command: gitlab-ctl restart unicorn
#   retries: 2
# END OF OPTIONAL TASKS

- name: Check GitLab health
  uri:
    url: http://127.0.0.1:8080/-/health
    return_content: yes
  # Register the output of the module in a variable
  register: gitlab_health

- name: Print GitLab health
  debug:
    msg: "{{ gitlab_health.content }}"

###########################################################
# Readiness check
###########################################################

- name: Check GitLab readiness
  uri:
    url: http://127.0.0.1:8080/-/readiness
    return_content: yes
  register: gitlab_readiness

- name: Print GitLab readiness
  debug:
    msg: "{{ gitlab_readiness.content }}"

###########################################################
# Liveness check
###########################################################

- name: Check GitLab liveness
  uri:
    url: http://127.0.0.1:8080/-/liveness
    return_content: yes
  register: gitlab_liveness

- name: Print GitLab liveness
  debug:
    msg: "{{ gitlab_liveness.content }}"

###########################################################
# Bonus â€“ print only dysfunctional services (readiness)
###########################################################

- name: Extract dysfunctional services from readiness JSON
  set_fact:
    gitlab_readiness_failed_services: >-
      {{
        gitlab_readiness.json.checks
        | dict2items
        | selectattr('value.status', 'ne', 'ok')
        | map(attribute='key')
        | list
      }}
  when: gitlab_readiness is defined and gitlab_readiness.json is defined

- name: Print dysfunctional services (readiness)
  debug:
    msg: "Dysfunctional services: {{ gitlab_readiness_failed_services | join(', ') }}"
  when:
    - gitlab_readiness_failed_services is defined
    - gitlab_readiness_failed_services | length > 0

- name: Print message when all readiness checks are OK
  debug:
    msg: "All GitLab readiness checks are OK."
  when:
    - gitlab_readiness_failed_services is defined
    - gitlab_readiness_failed_services | length == 0

